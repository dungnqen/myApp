function number_format(f,c,h,e){f=(f+"").replace(/[^0-9+\-Ee.]/g,"");var b=!isFinite(+f)?0:+f,a=!isFinite(+c)?0:Math.abs(c),k=(typeof e==="undefined")?",":e,d=(typeof h==="undefined")?".":h,j="",g=function(o,m){var l=Math.pow(10,m);return""+(Math.round(o*l)/l).toFixed(m)};j=(a?g(b,a):""+Math.round(b)).split(".");if(j[0].length>3){j[0]=j[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,k)}if((j[1]||"").length<a){j[1]=j[1]||"";j[1]+=new Array(a-j[1].length+1).join("0")}return j.join(d)}var Ordering=new function(){this.settings={related_url:null};this.org_select=function(c,d,b,a){if(d.item.empty===true){$(b).prev().val(null);$(b).val(null);c.preventDefault();return false}$(b).prev().val(d.item.value);$(b).val(d.item.label);var e=this.load_cart_storage();this.set_customer_storage(e,d.item.value,d.item.label);c.preventDefault()};this.load_cart_storage=function(){var a=JSON.parse(localStorage.getItem("cartStorage"));if(a===null){a={customer:{},delivery:{},items:[]};localStorage.setItem("cartStorage",JSON.stringify(a))}else{if(a.customer===undefined||a.items===undefined||a.delivery===undefined){a={customer:{},delivery:{},items:[]};localStorage.setItem("cartStorage",JSON.stringify(a))}}return a};this.save_cart_storage=function(a){localStorage.setItem("cartStorage",JSON.stringify(a))};this.set_customer_storage=function(g,c,a){g.customer["customer_id"]=c;g.customer["customer_name"]=a;this.save_cart_storage(g);var d=window.location;var f=d.search;var b=new URLSearchParams(f);b.set("cid",c);var e=d.origin+d.pathname+"?"+b.toString();window.location.href=e};this.set_delivery_method_pickup=function(a){var b=this.load_cart_storage();b.delivery["method"]="pickup";b.delivery["pickup_division_id"]=a;this.save_cart_storage(b);window.location.href=window.location.href};this.set_delivery_method_ship=function(f,a,d,e,b){var c=this.load_cart_storage();c.delivery["method"]="ship";c.delivery["shipping_address_id"]=f;if(a!==null){c.delivery["shipping_province"]=a}if(d!==null){c.delivery["shipping_district"]=d}if(e!==null){c.delivery["shipping_ward"]=e}if(b!==null){c.delivery["shipping_zip"]=b}this.save_cart_storage(c)};this.get_cart_item=function(c,b){var a=c.items;if(b>=0&&b<a.length){return a[b]}return null};this.set_cart_item=function(h,d,a,f,c,g,e){var b=h.items;if(d>=0&&d<b.length){b[d].part_id=a;b[d].part_options=JSON.stringify(f);b[d].pricing=c;b[d].pkg_quantity=g;b[d].user_quantity=e}else{b.push({part_id:a,part_options:JSON.stringify(f),pricing:c,pkg_quantity:g,user_quantity:e})}this.save_cart_storage(h)};this.remove_cart_item=function(c,b){var a=c.items;if(b>=0&&b<a.length){a.splice(b,1);this.save_cart_storage(c)}};this.on_user_quantity_button=function(e){var m=$(e).closest(".user-qty-group").find("input");var g=this.load_cart_storage();var a=m.data("part_id");var j=m.data("part_options");var h=m.data("pricing");var k=m.data("pkg_quantity");var d=m.val();var l=m.closest(".ivy-line").find(".ivy-part-desc").data("desc");var c=m.data("qty_min_order");var b=m.data("qty_multiplicity_order");toastr.options={closeButton:false,debug:false,newestOnTop:false,progressBar:false,positionClass:"toast-top-center",preventDuplicates:false,onclick:null,showDuration:"100",hideDuration:"1000",timeOut:"2000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};m.val(c);m.effect("highlight",{color:"#66BB6A"},200);if(d.length&&!isNaN(d)){if(Number(d)<Number(c)){toastr.error(IvyLanguage.get("ordering","min_qty_order_required","JS: Min quantity order is required!"))}else{if(Number(d)%Number(b)!=0){m.val(Number(d)-Number(d)%Number(b)+Number(b));toastr.error(IvyLanguage.get("ordering","mul_qty_order_required","JS: Multiplicity quantity order is required!"))}else{let itemIndex=this.find_item_index(g,a,j,k);let oldItem=this.get_cart_item(g,itemIndex);if(oldItem===null){this.set_cart_item(g,-1,a,j,h,k,""+d)}else{let oldqty=oldItem.user_quantity;this.set_cart_item(g,itemIndex,a,j,h,k,""+(Number(d)+Number(oldqty)))}var f=(l!=undefined?l:"Item added to cart!");f=f.replace("#444","#fff");f=f.replace("#555","#fff");f=f+"<br><small><b>Quantity: "+d+(k>1?" (pkg of "+k+")":"")+"</b></small>";toastr.success(f+'<br/><p style="text-align:right;margin:0"><a style="font-size:16px" href="javascript:void(0)" onclick="Ordering.go_to_cart();"><i class="fa fa-opencart" style="margin-right:6px"></i>Cart</a></p>')}}}else{toastr.warning(IvyLanguage.get("ordering","quantity_required","JS: Please input the quantity before adding to the shopping cart!"))}this.update_availability_desc(e,m.val(),c,b);Ordering.cart_count()};this.incart_modify_quantity=function(c){var k=$(c).closest(".ivy-line");var f=this.load_cart_storage();var a=Number(k.find("[name*='[part_id]']").val());var j="";try{j=JSON.parse(k.find("[name*='[part_options]']").val())}catch(g){}var l=Number(k.find("[name*='[quantity_coefficient]']").val());var b=$(c).val();var d=k.parent().children("tr.ivy-line").index(k);if(!isNaN(b)){var m=this.get_cart_item(f,d);var h=(m===null?0:m.pricing);this.set_cart_item(f,d,a,j,h,l,b);$(c).effect("highlight",{color:"#66BB6A"},200);k.find("a.update-price").show()}};this.incart_remove_line=function(b){var d=$(b).closest(".ivy-line");var c=this.load_cart_storage();var a=d.parent().children("tr.ivy-line").index(d);this.remove_cart_item(c,a);Ordering.cart_count()};this.org_change=function(c,d,b,a){if(d.item==null){$(b).prev().val(null);$(b).val(null);if(c!==null){c.preventDefault()}var e=this.load_cart_storage();this.set_customer_storage(e,0,"")}};this.org_add=function(d,c,b){if(typeof d=="string"||d instanceof String){d=JSON.parse(d)}var a=d;if(!$.isEmptyObject(a)&&c!==null){c.parent().prev().prev().val(a.organization_id);c.parent().prev().val(a.name);var e=this.load_cart_storage();this.set_customer_storage(e,a.organization_id,a.name)}};this.org_search=function(c,b,a){this.org_add(c,b,a)};this.contact_add=function(d,c,b){if(typeof d=="string"||d instanceof String){d=JSON.parse(d)}var a=d;if(!$.isEmptyObject(a)&&c!==null){c.parent().prev().prev().val(a.contact_id);c.parent().prev().val(a.name);var e=this.load_cart_storage();this.set_customer_storage(e,a.contact_id,a.name)}};this.contact_search=function(c,b,a){this.contact_add(c,b,a)};this.org_or_contact_search=function(d,c,b){if(typeof d=="string"||d instanceof String){d=JSON.parse(d)}var a=d;if(a.hasOwnProperty("organization_id")){this.org_search(d,c,b)}else{if(a.hasOwnProperty("contact_id")){this.contact_search(d,c,b)}}};this.go_to_cart=function(c){var b=null;if(c===undefined){var b=$("body").find("form#dynamic_cart_form")}else{b=$(c).parent().find("form#dynamic_cart_form")}var a=JSON.stringify(this.load_cart_storage());if(a.length>0){b.find('input[name="data"]').val(a);b.submit()}};this.clear_cart=function(b,a){localStorage.removeItem("cartStorage");if(a!==null&&a!==undefined){$(location).attr("href",a)}};this.continue_shopping=function(b,a){$(location).attr("href",a)};this.bring_parts_to_cart=function(a){if(confirm(IvyLanguage.get("ordering","confirm_add_all_parts","JS: Are you sure you want to add all parts here into the Shopping Cart?"))){var c=$(a);var b=this.load_cart_storage();if(b.items.length>0){if(confirm(IvyLanguage.get("ordering","clear_cart_before_add","JS: Your shopping cart is not empty! Do you want to clean the shopping cart before copying items? Press OK to clean the shopping cart before copying items. Press Cancel to copy items without cleaning the existed shopping cart"))){b.items=[]}}c.children().each(function(){var k=$(this);var d=Number(k.find("[name*='[part_id]']").val());if(d>0){var h="";try{h=JSON.parse(k.find("[name*='[part_options]']").val())}catch(j){}var l=Number(k.find("[name*='[quantity_coefficient]']").val());var g=Number(k.find("[name*='[quantity]']").val());var f=Number(k.find("[name*='[price]']").val());let itemIndex=Ordering.find_item_index(b,d,"",1);let oldItem=Ordering.get_cart_item(b,itemIndex);if(oldItem===null){Ordering.set_cart_item(b,-1,d,h,f,l,""+g)}else{let oldqty=oldItem.user_quantity;Ordering.set_cart_item(b,itemIndex,d,h,f,l,""+(Number(g)+Number(oldqty)))}}});this.go_to_cart()}};this.NumOnly=function(a){return a.charCode>=48&&a.charCode<=57};this.cart_count=function(){var a=$("#cart_items_count");if(a.length){var b=this.load_cart_storage();if(b.items.length>0){a.html(b.items.length);a.show()}else{a.html("");a.hide()}}};this.view_part_details=function(b,d){var c=$(b);c.addClass("loading");var a=c.closest("tr").next();if(a.hasClass("showdetails")){a.remove();return false}$.ajax({method:"GET",url:c.data("url")}).done(function(f){c.removeClass("loading");if(f.success===true){var j=c.closest("tr");var e=$('<tr class="showdetails">');var h=$('<td style="font-family:\'Courier New\'" colspan="'+d+'">');if(typeof f.attribute=="string"||f.attribute instanceof String){f.attribute=JSON.parse(f.attribute)}for(var g in f.attribute){if(f.attribute.hasOwnProperty(g)){h.append(g+" = "+f.attribute[g]+"<br/>")}}h.append(f.attribute);h.append(f.comment);e.append(h);e.insertAfter(j)}})};this.view_part_details_inline=function(a){var b=$(a);var c=b.closest("tr").find(".part-detail-container");if(c.hasClass("loaded")){c.toggle()}else{c.show();c.addClass("loading");c.html(IvyLanguage.get("ordering","loading","JS: Loading..."));$.ajax({method:"GET",url:b.data("url")}).done(function(e){c.removeClass("loading");c.addClass("loaded");if(e.success===true){var d=$("<div>");if(typeof e.attribute=="string"||e.attribute instanceof String){e.attribute=JSON.parse(e.attribute)}for(var f in e.attribute){if(e.attribute.hasOwnProperty(f)){d.append(f+": <b>"+e.attribute[f]+"</b><br/>")}}c.html("").append(d)}else{c.html(IvyLanguage.get("ordering","no_more_detail","JS: No more details to show!"))}})}};this.filter_pre_defined=function(b){var c=window.location;var e=c.search;var a=new URLSearchParams(e);var d=c.origin+c.pathname+"?"+a.toString();$.ajax({method:"GET",url:$(b).data("url"),data:{only:($(b).is(":checked")==true?1:0)}}).done(function(f){window.location.href=d})};this.fix_top_element=function(c){var d=$(c);var b=$(c).find(":first-child");var a=Math.max(d.outerHeight(true),b.outerHeight(true));d.css("height",a+"px");b.addClass("navbar-fixed-top")};this.load_and_show=function(b){var c=$(b);c.addClass("loading");var a=c.closest("tr").next();if(a.hasClass("showdetails")){a.toggle();return false}$.ajax({method:"GET",url:c.data("url")}).done(function(f){c.removeClass("loading");var h=c.closest("tr");var e=$('<tr class="showdetails">');var g=$('<td colspan="'+(h.children().length-1)+'" style="border-top:none">');var d=$('<div class="part-detail-container" style="min-width:400px;min-height:452px">');d.html(f);g.append(d);e.append($('<td style="border-top:none">'));e.append(g);e.insertAfter(h);e.find(".sp-wrap").deleteSmoothProducts();e.find(".sp-wrap").smoothproducts()})};this.on_decrease_quantity_button=function(c){var f=$(c).closest("div").find("input");var d=f.data("qty_min_order");var e=f.data("qty_multiplicity_order");var b=0;if(f.val().length&&!isNaN(f.val())){var b=parseInt(f.val())}var a=d;if(b>d){if(b%e!=0){a=b-(b%e)}else{a=b-e}}f.val(a);this.update_availability_desc(c,a,d,e)};this.on_increase_quantity_button=function(b){var e=$(b).closest("div").find("input");var c=parseInt(e.data("qty_min_order"));var d=e.data("qty_multiplicity_order");var a=0;if(e.val().length&&!isNaN(e.val())){var a=parseInt(e.val())}a=a-(a%d)+d;if(a<c){a=c}e.val(a);this.update_availability_desc(b,a,c,d)};this.on_blur_quantity_input=function(b){var e=$(b);var c=parseInt(e.data("qty_min_order"));var d=parseInt(e.data("qty_multiplicity_order"));toastr.options={closeButton:false,debug:false,newestOnTop:false,progressBar:false,positionClass:"toast-top-center",preventDuplicates:false,onclick:null,showDuration:"100",hideDuration:"1000",timeOut:"2000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};var a=c;if(e.val().length&&!isNaN(e.val())){var a=parseInt(e.val());if(a<c){a=c;toastr.warning(IvyLanguage.get("ordering","min_qty_order_required","JS: Min quantity order is required!"))}}else{toastr.warning(IvyLanguage.get("ordering","quantity_required","JS: Please input the quantity before adding to the shopping cart!"))}if(a>c&&a%d!=0){toastr.warning(IvyLanguage.get("ordering","mul_qty_order_required","JS: Multiplicity quantity order is required!"));a=a-(a%d)+d}e.val(a);this.update_availability_desc(b,a,c,d)};this.on_add_to_purchase_plan_button=function(f){var n=$(f).closest(".select_inventory_stock_line").find("input");var e=n.val();var a=n.data("part_id");var k=n.data("ipc_number");var o=n.data("description");var g=n.data("mecsu_part_desc");var m=$("#purchase-plan-lines-table tbody");var d="";var j="<td>"+k+"</td>";var h="<td>"+o+"</td>";var l="<td>"+g+"</td>";var c='<td><input type="number" name="quantity['+a+']" value="'+e+'"></td>';var b='<td><button class="btn btn-danger" style="height: 28px; padding-top:3px" onclick="Ordering.table_remove_line(this);"><i class="fa fa-fw fa-times-circle"></i></button></td>';m.append("<tr><td>"+d+"</td>"+j+h+l+c+b+"</tr>");n.val(1)};this.on_add_to_consumption_button=function(b){var f=$(b).closest(".select_exventory_line").find("input");var c=f.val();var h=f.data("part_id");var r=f.data("ipc_id");var n=f.data("ipc_number");var q=f.data("description");var o=f.data("mecsu_part_desc");var j=$("#consumption-lines-table tbody");var s="consumption_line_quantity_"+r;var p=j.find("tr input#"+s);if(p.length>0){var l=Number(p.val())+Number(c);p.val(l);f.val(1)}else{var a="";var k="<td>"+n+"</td>";var m="<td>"+q+"</td>";var d="<td>"+o+"</td>";var e='<td><input id="'+s+'" type="number" name="quantity['+r+']" value="'+c+'"></td>';var g='<td><button class="btn btn-danger" style="height: 28px; padding-top:3px" onclick="Ordering.table_remove_line(this);"><i class="fa fa-fw fa-times-circle"></i></button></td>';j.append("<tr>"+k+m+d+e+g+"</tr>");f.val(1)}};this.on_add_to_sourcing_request_button=function(){var c=$("#sourcing-request-lines-table tbody");var g=$("#sourcing-request-lines-table tbody tr").length;var f='<td><input type="text" name="description['+g+']" style="width: 250px"></td>';var e='<td><input type="text" name="customerPart['+g+']" style="width: 100px"></td>';var d='<td><input type="text" name="quantity['+g+']" style="width: 70px"></td>';var a='<td><input type="text" name="expectedPrice['+g+']" style="width: 100px"></td>';var b='<td><input type="text" name="referenceLink['+g+']" style="width: 150px"></td>';var h='<td><button class="btn btn-danger" style="height: 28px; padding-top:3px" onclick="Ordering.table_remove_line(this);"><i class="fa fa-fw fa-times-circle"></i></button></td>';c.append("<tr><td>"+g+"</td>"+f+e+d+a+b+h+"</tr>")};this.table_remove_line=function(a){var b=$(a).closest("tr");b.remove()};this.add_to_purchase_plan=function(c){var b=null;if(c===undefined){var b=$("body").find("form#purchased_product_form")}else{b=$(c).closest("form#purchased_product_form")}var a=b.attr("action")+"?"+b.serialize();$.ajax({method:"GET",url:a}).done(function(g){if(g.success===true){var l=JSON.parse(g.data);var n=$("#purchase-plan-lines-table tbody");var f="";var h=g.extraData.purchased_quantity;var k="<td>"+(l.customer_part_numbers===null?"N/A":l.customer_part_numbers)+"</td>";var j="<td>"+(l.customer_part_descriptions===null?"N/A":l.customer_part_descriptions)+"</td>";var m="<td>"+g.extraData.mecsu_part_desc+"</td>";var e='<td><input type="number" name="quantity['+g.extraData.part_id+']" value="'+h+'"></td>';var d='<td><button class="btn btn-danger" style="height: 28px; padding-top:3px" onclick="Ordering.table_remove_line(this);"><i class="fa fa-fw fa-times-circle"></i></button></td>';n.append("<tr><td>"+f+"</td>"+k+j+m+e+d+"</tr>");b.trigger("reset")}else{alert(g.message)}})};this.copy_parts_to_cart=function(a){if(confirm(IvyLanguage.get("ordering","confirm_add_all_parts","JS: Are you sure you want to add all parts here into the Shopping Cart?"))){var c=$(a).find("tbody");var b=this.load_cart_storage();b.items=[];c.children().each(function(){var k=$(this);var d=Number(k.find("[name*='[part_id]']").val());if(d>0){var h="";try{h=JSON.parse(k.find("[name*='[part_options]']").val())}catch(j){}var l=Number(k.find("[name*='[quantity_coefficient]']").val());var g=Number(k.find("[name*='[quantity]']").val());var f=Number(k.find("[name*='[price]']").val());Ordering.set_cart_item(b,-1,d,h,f,l,""+(g))}});alert(IvyLanguage.get("ordering","all_item_added","JS: All items were added into your shopping cart! Now you can go to your shopping cart to check it!"))}};this.on_sourcing_request_feedback=function(c){var b=$(c).closest("form#sourcing_request_feedback_form");var e=$(c).data("customer_id");if(b!=null){var d=b.find('select[name="customer_feedback"]');var a=b.attr("action");$.ajax({method:"POST",url:a,data:{customer_feedback:d.val(),customer_id:e}}).done(function(f){if(f===true){var g=$(c).closest("tr");g.css("background-color","transparent");d.prop("disabled",true);$(c).prop("disabled",true);alert("Đã gửi phản hồi thành công")}else{alert("Xảy ra lỗi khi gửi phản hồi")}}).fail(function(){alert("Xảy ra lỗi khi gửi phản hồi")})}};this.find_item_index=function(g,a,d,f){d=JSON.stringify(d);var b=g.items;var e=b.length;for(var c=0;c<e;c++){if(a===b[c].part_id&&d===b[c].part_options&&f===b[c].pkg_quantity){return c}}return -1};this.update_availability_desc=function(f,b,e,a){var l=$(f).closest(".user-qty-group").find(".availability-desc");var n=parseInt(l.data("stock_quantity"));var d=l.data("stock_division");var h=l.data("unit_name");var k=l.data("lead_time");var m=l.data("available_time");var c=0;var j;if(n<e){j="Dự kiến xuất kho từ "+d+" vào ngày <b>"+k+"</b>"}else{if(n>=b){j="Dự kiến xuất kho từ "+d+' trước <span class="text-blue">'+m+"</span>"}else{if(b>=e){c=n-(n%a);j="Dự kiến xuất kho <b>"+c+" "+h+"</b> từ "+d+' trước <span class="text-blue">'+m+"</span>";j+=", <b>"+(b-c)+" "+h+"</b> vào ngày <b>"+k+"</b>"}else{}}}l.html(j);var g=$(f).closest(".user-qty-group").find(".unit-price");if(g.length!=0){let pricing_table_encode=g.data("pricing_table");let sub_pricings_encode=pricing_table_encode.split(";");let pricings=[];let index=0;for(let i=0;i<sub_pricings_encode.length;i++){element=sub_pricings_encode[i];if(element!=""){let segs=element.split("-");pricings[index]={quantity:segs[0],price:segs[1]};index++}}pricings.sort(function(p,o){return p.quantity-o.quantity});let result_price=0;for(let i=0;i<pricings.length;i++){if(b>=pricings[i].quantity){result_price=pricings[i].price}}g.text(number_format(result_price,0,".",","))}}};